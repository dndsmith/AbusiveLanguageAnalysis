import boto3
from boto3 import Session
import sys
import magic
import subprocess
import codecs


# finds the file extension
def findMimeType(inFile):
    mime = magic.Magic(mime=True)
    fileMime = mime.from_file(inFile)
    fileType = fileMime.split('/')

    # returns file type
    return fileType[0]


def uploadS3(bucketname, filename):
    s3 = boto3.client('s3')
    # upload to s3
    s3.upload_file(filename, bucketname, filename)


def transcribe(bucketname, filename):
    transcribe = boto3.client('transcribe')
    jobName = "transcribe speech"

    # link to s3 endpoint
    jobURI = "s3://" + bucketname + "/" + filename

    # transcribe audio and outputs transcript into s3 bucket
    transcribe.start_transcription_job(
        TranscriptionJobName=jobName,
        LanguageCode='en-US',
        Media={'MediaFileUri': jobURI},
        OutputBucketName=bucketname
    )


def rekognition(bucketname, file):
    fullText = ''

    rekognition = boto3.client('rekognition')
    # looking at object
    response = rekognition.detect_text(Image={'S3Object': {'Bucket': bucketname, 'Name': file}})
    textDectections = response['TextDetections']

    # printing out detected text in photos
    for text in textDectections:
        fullText = fullText + text['DetectedText'] + ' '

    # create text file from the detected photo
    outfile = open('rekognition.txt', 'w')
    outfile.write(fullText)
    uploadS3(bucketname, outfile)

    return outfile


# speech to text
def polly(bucketname, textFile):
    #cnt = 0
    #file_names = ''
    polly = Session(aws_access_key_id='AKIAJNCMWPAOOPZAKCQA', aws_secret_access_key='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', region_name='us-east-1').client('polly')

    with open(textFile, 'r') as file:
        text = file.read()

    response = polly.synthesize_speech(VoiceId='Joanna', OutputFormat='mp3', Text=text)

    mp3 = open('result.mp3', 'wb')
    mp3.write(response['AudioStream'].read())
    mp3.close()

    uploadS3(bucketname, 'result.mp3')
    

    #for line in textFile:
    #    rendered = ''
    #    line = line.replace('"', '\\"')
    #    command = 'aws polly synthesize-speech --text-type ssml --output-format "mp3" --voice-id "Joanna" --text "<speak>' + text + '</speaker>"'

    #    if '\r\n' == line:
            # A pause after a paragraph
    #        rendered = '<speak><break time= "2s"/></speak>'
    #    else:
            # A pause after a sentence
    #        rendered = '<speak><amazon:effect name=\\"drc\\">' + line.strip() + '<break time=\\"1s\\"/></amazon:effect></speak>'

   #     file_name = ' polly_out{0}.mp3'.format(u''.join(str(cnt)).encode('utf-8'))
    #    cnt += 1
    #    command = command.format(rendered.encode('utf-8'), file_name)
    #    file_names += file_name
        #print(command)
    #    subprocess.call(command, shell=True)

    
    #print(file_names)
    #mp3File = 'result.mp3'

    #execute_command = 'cat ' + file_names + '>' + mp3File
    #subprocess.call(execute_command, shell=True)

    #execute_command = 'rm ' + file_names
    #print('Removing temporary files: ' + execute_command)
    #subprocess.call(execute_command, shell=True)



if __name__ == '__main__':
    bucketname = 'hackgt6files'

    # get file type
    inFile = sys.argv[1]
    fileType = findMimeType(inFile)

    if fileType == 'image':
        uploadS3(bucketname, inFile)
        outfile = rekognition(bucketname, inFile)
        polly(bucketname, outfile)
    elif fileType == 'text' or 'application':
        polly(bucketname, inFile)
    elif fileType == 'audio':
        uploadS3(bucketname, inFile)
        transcribe(bucketname, inFile)
    else:
        print("Sorry, we do not accept this file type")
